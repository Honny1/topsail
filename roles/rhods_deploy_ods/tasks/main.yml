---
- name: Set RHODS version
  set_fact:
    rhods_catalog_version: v160-8

- name: Apply the RHODS catalog template
  template:
    src: "{{ rhods_install_ods_catalog }}"
    dest: "{{ artifact_extra_logs_dir }}/000_rhods_catalog.yml"
    mode: 0400

- name: Test if the RHODS catalog is available
  command: oc get -f "{{ artifact_extra_logs_dir }}/000_rhods_catalog.yml" -oname
  failed_when: false
  register: has_rhods_catalog_cmd

- name: Create RHODS catalog if it does not exist
  when: has_rhods_catalog_cmd.rc != 0
  command: oc apply -f "{{ artifact_extra_logs_dir }}/000_rhods_catalog.yml"

- name: Create RHODS namespaces
  shell:
    oc create ns {{ item }} --dry-run=client -oyaml | oc apply -f-
  loop:
  - redhat-ods-operator
  - redhat-ods-applications
  - redhat-ods-monitoring

- name: Test if the RHODS operator is installed
  command:
     oc get subscription.operators.coreos.com -A -oname
       -loperators.coreos.com/rhods-operator.openshift-operators
  failed_when: false
  register: has_rhods_operator_cmd

- name: Install RHODS operator
  when: not has_rhods_operator_cmd.stdout
  include_role:
    name: cluster_deploy_operator
  vars:
    cluster_deploy_operator_catalog: addon-managed-odh-catalog
    cluster_deploy_operator_manifest_name: rhods-operator
    cluster_deploy_operator_namespace: openshift-operators
    cluster_deploy_operator_channel: beta
    cluster_deploy_operator_all_namespaces: "True"
