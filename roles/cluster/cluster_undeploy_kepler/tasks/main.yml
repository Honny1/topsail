- name: Check if go is installed
  command:
    which go
  register: check_go

- name: Install go if needed
  command:
    dnf install go-toolset
  when: check_go.rc != 0

- name: Grab kepler-operator source
  shell: |
    git clone --quiet https://github.com/sustainable-computing-io/kepler-operator "/tmp/kepler" &2>1
    git --git-dir "/tmp/kepler/.git" show

- name: Undeploy kepler-operator
  shell:
    cd "/tmp/kepler"; make uninstall; make undeploy &2>1

- name: Delete kepler-monitor ServiceMonitor
  shell:
    oc delete -n openshift-kepler-operator servicemonitor kepler-monitor --ignore-not-found

- name: Delete kepler namespaces
  shell:
    oc delete ns openshift-kepler-operator kepler-operator-system --ignore-not-found
