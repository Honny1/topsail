{% set secrets_location = secrets.dir.name | or_env(secrets.dir.env_key) %}
{% if not secrets_location %}
  {{ ("ERROR: secrets_location must be defined (secrets.dir.name="+ secrets.dir.name|string +" or env(secrets.dir.env_key=" + secrets.dir.env_key|string + ")) ") | raise_exception }}
{% endif %}
{% set s3_ldap_password_location = secrets_location + "/" + secrets.s3_ldap_password_file %}

cluster deploy_ldap:
  idp_name: {{ ldap.idp_name }}
  secret_properties_file: {{ s3_ldap_password_location }}
  username_count: {{ ldap.users.count }}
  username_prefix: {{ ldap.users.prefix }}

rhods deploy_ods:
  catalog_image: {{ rhods.catalog.image }}
  tag: {{ rhods.catalog.tag }}
  channel: {{ rhods.catalog.channel }}
  version: {{ rhods.catalog.version }}

pipelines deploy_application:
  namespace: {{ rhods.pipelines.namespace }}
  name: {{ rhods.pipelines.application.name }}

sutest/cluster set_scale:
  instance_type: {{ clusters.create.ocp.compute.type }}
  name: {{ clusters.sutest.compute.machineset.name }}
{% if clusters.sutest.compute.dedicated %}
  taint: {{ clusters.sutest.compute.machineset.taint.key }}={{ clusters.sutest.compute.machineset.taint.value }}:{{ clusters.sutest.compute.machineset.taint.effect }}
{% endif %}
  scale: 1

sutest/cluster set_project_annotation/pipelines_node_selector:
  key: openshift.io/node-selector
  value: "{{ clusters.sutest.compute.machineset.taint.key }}={{ clusters.sutest.compute.machineset.taint.value }}"
  project: {{ rhods.pipelines.namespace }}

sutest/cluster set_project_annotation/pipelines_toleration:
  key: scheduler.alpha.kubernetes.io/defaultTolerations
  value: '[{\"operator\": \"Exists\", \"effect\": \"{{ clusters.sutest.compute.machineset.taint.effect }}\", \"key\": \"{{ clusters.sutest.compute.machineset.taint.key }}\"}]'
  project: {{ rhods.pipelines.namespace }}
