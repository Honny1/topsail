#!/bin/bash

set -o pipefail
set -o errexit
set -o nounset
set -o errtrace

echo "--- Starting User Data Script ---"

DEVICE_NAME=xvdf4

MOUNT_POINT="/mnt/"
echo "Device identified as /dev/${DEVICE_NAME}"
mkdir -p ${MOUNT_POINT}
sudo mount /dev/${DEVICE_NAME} ${MOUNT_POINT}


echo "--- Filesystem mounted ---"

sudo dnf install -y git > /dev/null

ROOT_FS=$(echo $MOUNT_POINT/ostree/deploy/rhcos/deploy/*.0)

# --- !!! YOUR MODIFICATIONS GO HERE !!! ---

cd /tmp
git clone "{{ crc_timing_refresh_image_git_repo }}" -b "{{ crc_timing_refresh_image_git_branch }}"
cd snc
git show --quiet

sudo cp -v systemd/*.sh $MOUNT_POINT/ostree/deploy/rhcos/var/usrlocal/bin/
sudo chmod ugo+x $MOUNT_POINT/ostree/deploy/rhcos/var/usrlocal/bin/*.sh
sudo cp -v systemd/*.service ${ROOT_FS}/etc/systemd/system

sudo rm -f ${ROOT_FS}/etc/systemd/system/crc-no-tap.service

# Mute ovs-configuration.service

sudo mkdir ${ROOT_FS}/etc/systemd/system/ovs-configuration.service.d
cat | sudo tee ${ROOT_FS}/etc/systemd/system/ovs-configuration.service.d/mute-console.conf <<EOF
[Service]
StandardOutput=file:/var/log/ovs-configure.log
StandardError=file:/var/log/ovs-configure.log
EOF

cat | sudo tee ${ROOT_FS}/etc/sysconfig/crc-env <<EOF
CRC_SELF_SUFFICIENT=1
CRC_NETWORK_MODE_USER=0
EOF

# --- !!! END OF MODIFICATIONS !!! ---

echo "--- Unmounting filesystem ---"
sudo umount ${MOUNT_POINT}
